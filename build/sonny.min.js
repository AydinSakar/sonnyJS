/**
 * sonnyJS v0.1.2
 * www.github.com/felixmaier/sonnyJS
 * @author Felix Maier
 */
(function(){var g=function(a){return document.querySelector(a)},b=b||{};b.VERSION="0.1.2";b.PAGEPATH="view/";b.FILETYPE=".html";b.STORAGE_EXT="SY::";b.HISTORY=window.history&&"object"===typeof window.onpopstate?!0:!1;b.LOCALSTORAGE="undefined"!==typeof Storage||void 0!==window.localStorage?!0:!1;b.ORIGINALHISTORY=window.location.href;b.INITIALIZED=0;b.SHOWVERSION=!1;b.Virtualiser=function(a){var c=this;b.LOADED||this.init(this.VIRTUALPAGES,function(d){c.PAGES=d;c.PAGES=c.interpreter.Includes(d);b.LOADED=
!0;a();c.STARTPAGE?c.renderer.render(c.STARTPAGE):c.history&&c.history.additionalURL.length&&c.CURRENTPAGE!==c.history.additionalURL&&c.renderer.render(c.history.additionalURL+b.FILETYPE)})};b.Virtualiser.prototype.constructor=b.Virtualiser;b.Virtualiser.prototype.init=function(a,c){var d=this,e={};if("object"===typeof a){var f=[];Object.keys(a).forEach(function(b){f.push(a[b])});f.length&&(a=f)}var k=function(a){"string"===typeof a[0]&&d.GET(b.PAGEPATH+a[0],function(f){if(e[a[0]])throw Error("Multiple definition of "+
e[a[0]].path+"!");var h=d.compiler;f=h.DOM(f);if("APP"!==f.tagName)throw Error('Missing "app" tag in '+a[0]+"!");h=h.HTML(f);h.content=h.inside;h.path=a[0];delete h.inside;e[a.shift()]=new b.Page(h);a.length?k(a):c(e)})};k(a)};b.Virtualiser.prototype.GET=function(a,c){var d=new b.GET;d.onload=function(){if(200===this.status)c(this.responseText);else throw Error("Status code was "+this.status);};d.open("GET",a+"?"+(new Date).getTime(),!0);d.overrideMimeType&&d.overrideMimeType("text/html");d.send(null)};
b.Page=function(a){this.name=String(a["sy-sitename"]);this.path=String(a.path);this.requireServer=Boolean(a["sy-requireserver"])||!1;this.content=a.content;this.renderedTimes=this.includes=0;this.global=Boolean(a.global)||!1;this.ready=!0};b.Page.prototype.constructor=b.Page;b.Interpreter=function(a){a&&(this.__instance=a)};b.Interpreter.prototype.constructor=b.Interpreter;b.Interpreter.prototype.Includes=function(a){var c=this,d=a,e=function(a){for(var b in a)"object"===typeof a[b]&&(e(a[b]),a.content&&
(d=a,a.content=f(a.content)));return a},f=function(a){for(var e in a)if("object"===typeof a[e]&&(a[e]=f(a[e]),a[e].key&&"syinclude"===a[e].key)){d.includes++;var g=f(c.__instance.renderer.get(a[e].page+b.FILETYPE)).content;a.splice(e,!0);a.splice.apply(f(a),[e,0].concat(g))}return a};return e(d)};b.Compiler=function(a){a&&(this.__instance=a)};b.Compiler.prototype.constructor=b.Compiler;b.Compiler.prototype.DOM=function(a){var b=document.implementation.createHTMLDocument("html");b.documentElement.innerHTML=
a;return b.body.children[0]};b.Compiler.prototype.HTML=function(a){if(!a instanceof Object)throw Error("Received arguments of invalid type");var b={};b.key=a.tagName.toLowerCase();if(a.hasAttribute)for(var d=0;d<a.attributes.length;d++)b[a.attributes[d].name]=a.attributes[d].value;if(a.hasChildNodes()){a=a.firstChild;3===a.nodeType&&""!==a.data.trim()&&(b.text=a.data);if(3===a.nodeType&&a.nextSibling||1===a.nodeType)b.inside=[];for(;a;)1===a.nodeType&&b.inside.push(this.HTML(a)),a=a.nextSibling}return b};
b.Compiler.prototype.JSON=function(a,c){var d,e=[];if("syinclude"!==a.key){for(var f in a)if("key"===f)d=document.createElement(a.key);else if("text"===f)d.innerHTML=a.text;else if("inside"===f){if(a.inside)for(var k=0;k<a.inside.length;++k){var g=this.JSON(a.inside[k]),l;for(l in g)d.appendChild(g[l])}}else try{d&&"backup"!==f&&d.setAttribute(f,a[f])}catch(h){throw Error("JSON rendering failed: "+h);}d=(new b.Vivifier(this.__instance)).vivify(d);e.push(d)}return e};b.Vivifier=function(a){this.instance=
a||this};b.Vivifier.prototype.constructor=b.Vivifier;b.Vivifier.prototype.vivify=function(a){var c=this;if(!a)throw Error("Invalid element type!");a.attributes["sy-load"]&&(a.attributes["sy-load"].value.match(":")?a=this.addListeners(a,"sy-load"):a.addEventListener("click",function(){c.instance.render(a.attributes["sy-load"].value+b.FILETYPE)}));return a};b.Vivifier.prototype.addListeners=function(a,c){var d=this,e=a.attributes[c].value.split(":");if(2<=e[0].split("&").length)for(var e=e[0].match("&")?
e[0].split("&"):e,f=0;f<e.length;f++)e[f].trim(),a.addEventListener(e[f],function(){d.instance.render(a.attributes[c].value.split(":")[1]+b.FILETYPE)});else a.addEventListener(e[0],function(){d.instance.render(e[1]+b.FILETYPE)});return a};b.Renderer=function(a){a&&(this.__instance=a)};b.Renderer.prototype.constructor=b.Renderer;b.Renderer.prototype.render=function(a,c){a.match(b.FILETYPE)&&(a=a.split(b.FILETYPE)[0]);if(!a instanceof String)throw Error("Invalid page format!");this.page=this.get(a+
b.FILETYPE);this.page.global||(this.__instance.CURRENTPAGE=a);this.page.rendered=this.compile(this.page);this.compile(this.page);this.attach(this.page);!b.HISTORY||c||this.page.global||this.__instance.history.update(this.__instance.CURRENTPAGE)};b.Renderer.prototype.kill=function(a){if(a)switch(a){case "local":this.__instance.CONTAINERS.BODY.innerHTML="";break;case "global":this.__instance.CONTAINERS.GLOBALBODY.innerHTML=""}else this.__instance.CONTAINERS.BODY&&(this.__instance.CONTAINERS.BODY.innerHTML=
"")};b.Renderer.prototype.compile=function(a){var c=new b.Compiler(this),d=[];a=a.content||a;for(var e in a)d.push(c.JSON(a[e]));this.page.global||this.kill();return d};b.Renderer.prototype.attach=function(a){var b=this,d=function(a,d){if(a.rendered)for(var g in a.rendered)for(var m in a.rendered[g])b.__instance.CONTAINERS[d].appendChild(a.rendered[g][m])};a.global?d(a,"GLOBALBODY"):d(a,"BODY")};b.Renderer.prototype.get=function(a){if(this.__instance.PAGES[a])a=this.__instance.PAGES[a];else throw Error("The page "+
a+" does not exist or was not successfully loaded!");return a};b.Notifications=function(a){a&&(this.__instance=a);"Notification"in window&&(this.notifySupport=!0,this.notification=null,this.permission=Notification.permission)};b.Notifications.prototype.constructor=b.Notifications;b.Notifications.prototype.show=function(a){this.notifySupport&&this.__instance.DISPLAYNOTIFICATIONS&&("granted"===this.permission?"object"===typeof a&&(this.notification=new Notification(a.title,{tag:a.tag?a.tag:null,body:a.message?
a.message:null,iconUrl:a.iconUrl?a.iconUrl:null,icon:a.icon?a.icon:null})):"denied"!==this.permission&&this.getPermission(a))};b.Notifications.prototype.getPermission=function(a){var b=this;Notification.requestPermission(function(d){"granted"===d&&b.show(a)})};b.Connection=function(a){if(!window.io)throw Error("SonnyJS requires Socket.IO!");if(a)this.__instance=a;else throw Error("SONNY.Connection requires an instance parameter!");this.connected=!1;this.socket=io(window.location.host+":"+this.__instance.CONNECTIONPORT);
this.connected=!0;this.__instance.ONLINE=!0;this.notifications=this.__instance.notify;this.init()};b.Connection.prototype.constructor=b.Connection;b.Connection.prototype.init=function(){var a=this;this.socket.on("connect",function(){a.notifications.show({title:"SONNY.Connection",message:"Connection established!",icon:"http://sonnyjs.org/favicon-96x96.png"})});this.socket.on("disconnect",function(){a.socket.disconnect();a.notifications.show({title:"SONNY.Connection",message:"Connection closed!",icon:"http://sonnyjs.org/favicon-96x96.png"})})};
b.HistoryManager=function(a){a&&(this.__instance=a);b.HISTORY&&(this.additionalURL=this.originalURL="",this.init())};b.HistoryManager.prototype.constructor=b.HistoryManager;b.HistoryManager.prototype.init=function(){var a=this,c=this.originalURL=b.ORIGINALHISTORY;RegExp("\\?","g").test(c)&&(c=c.split("?"),c[0]!==b.ORIGINALHISTORY&&(b.ORIGINALHISTORY=c[0],this.originalURL=b.ORIGINALHISTORY),c.length&&(this.additionalURL=c[1]));window.onpopstate=function(b){b.state&&null!==b.state&&a.__instance.renderer.render(b.state,
[])}};b.HistoryManager.prototype.update=function(a){history.pushState(a,a,this.originalURL+"?"+a)};b.StorageManager=function(a){if(a)this.__instance=a;else throw Error("SONNY.StorageManager requires an instance parameter!");b.LOCALSTORAGE&&(this.Storage=this.StorageName=null,this.activeWindows=1,this.__instance.GLOBALKEYS={},this.EmptyStorageTemplate={initialized:!0},this.init())};b.StorageManager.prototype.constructor=b.StorageManager;b.StorageManager.prototype.init=function(){var a=this;this.synchonize();
this.StorageName=b.STORAGE_EXT+"Instance::"+(new Date).getTime();localStorage[this.StorageName]||localStorage.setItem(this.StorageName,JSON.stringify(this.EmptyStorageTemplate));this.Storage=JSON.parse(localStorage[this.StorageName]);for(var c in localStorage)c.match(b.STORAGE_EXT+"Instance::")&&c!==a.StorageName&&localStorage.removeItem(c);window.addEventListener("beforeunload",function(){localStorage.removeItem(a.StorageName)});window.addEventListener("storage",function(b){a.countWindows();localStorage[a.StorageName]||
localStorage.setItem(a.StorageName,JSON.stringify(a.Storage));a.synchonize()})};b.StorageManager.prototype.onupdate=function(a){var c={};window.addEventListener("storage",function(){for(var d in localStorage)d.match(b.STORAGE_EXT)&&!d.match(b.STORAGE_EXT+"Instance")&&(c[d.split("::")[1]]=localStorage[d],a(c))})};b.StorageManager.prototype.keyExists=function(a){return this.__instance.GLOBALKEYS[a]||localStorage[b.STORAGE_EXT+a]?!0:!1};b.StorageManager.prototype.createKey=function(a){this.keyExists(a.name)||
(this.__instance.GLOBALKEYS[a.name]=a.data,localStorage.setItem(b.STORAGE_EXT+a.name,a.data))};b.StorageManager.prototype.deleteKey=function(a){delete this.__instance.GLOBALKEYS[a.name];localStorage.removeItem(b.STORAGE_EXT+a.name)};b.StorageManager.prototype.updateKey=function(a){this.keyExists(a.name)&&(this.__instance.GLOBALKEYS[a.name]=a.data,localStorage.setItem(b.STORAGE_EXT+a.name,a.data))};b.StorageManager.prototype.synchonize=function(){var a={},c;for(c in localStorage)c.match(b.STORAGE_EXT)&&
!c.match(b.STORAGE_EXT+"Instance")&&(a[c.split("::")[1]]=localStorage[c],this.__instance.GLOBALKEYS[c.split("::")[1]]?this.__instance.GLOBALKEYS[c.split("::")[1]]=localStorage[c]:this.__instance.GLOBALKEYS[c.split("::")[1]]||(this.__instance.GLOBALKEYS[c.split("::")[1]]=localStorage[c]));return a};b.StorageManager.prototype.countWindows=function(){this.activeWindows=0;for(var a in localStorage)a.match(b.STORAGE_EXT+"Instance::")&&this.activeWindows++;return this.activeWindows};b.Instance=function(a,
c){if(1<++b.INITIALIZED)throw Error("Cannot run multiple sonny instances!");var d=this;this.Greet();this.INSTANCE=this;this.STARTPAGE=null;this.CONTAINERS={};this.CONTAINERS.BODYCONTAINER="syContainer";this.CONTAINERS.GLOBALCONTAINER="syGlobal";this.CURRENTPAGE=null;this.WIDTH=window.innerWidth;this.HEIGHT=window.innerHeight;this.CONNECTION=this.ONLINE=this.FULLSCREEN=!1;this.CONNECTIONPORT=9005;this.DISPLAYNOTIFICATIONS=!0;this.processSettings(a);this.VIRTUALPAGES=a;this.isMobile();this.resize();
this.CONTAINERS.BODY=g(this.CONTAINERS.BODYCONTAINER)||null;this.CONTAINERS.GLOBALBODY=g(this.GLOBALCONTAINER)||null;this.renderer=new b.Renderer(this);this.interpreter=new b.Interpreter(this);this.compiler=new b.Compiler(this);this.notify=new b.Notifications(this);this.history=new b.HistoryManager(this);this.createContainer(function(){b.Virtualiser.call(d,function(){d.CONNECTION?d.CONNECTION=new b.Connection(d):null;c()})})};b.Instance.prototype=Object.create(b.Virtualiser.prototype);b.Instance.prototype.constructor=
b.Instance;b.Instance.prototype.createContainer=function(a){var b=this;window.addEventListener("DOMContentLoaded",function(){if(!b.CONTAINERS.BODY&&!b.CONTAINERS.BODY){var d=document.createElement(b.CONTAINERS.BODYCONTAINER),e=document.createElement(b.CONTAINERS.GLOBALCONTAINER);b.CONTAINERS.BODY=g("body");b.CONTAINERS.BODY.appendChild(e);b.CONTAINERS.BODY.appendChild(d);b.CONTAINERS.BODY=g(d.tagName.toLowerCase());b.CONTAINERS.GLOBALBODY=g(e.tagName.toLowerCase())}a()})};b.Instance.prototype.processSettings=
function(a){if(a.Settings){if(!a.Settings instanceof Object)throw Error("Invalid settings type");for(var b in a.Settings){if(null===a.Settings[b]||void 0===a.Settings[b])throw Error(b+" value is invalid");var d=b;b=String(b.toUpperCase());if(void 0!==this[b]||null===this[b])this[b]=a.Settings[d]}delete a.Settings}};b.Instance.prototype.Greet=function(){-1<navigator.userAgent.toLowerCase().indexOf("chrome")?console.log.apply(console,["%c sonny.js "+b.VERSION+" ->%c http://www.sonnyjs.org/ ","color: #d9d9d9; background: #000",
"background: #000"]):window.console&&console.info("sonny.js "+b.VERSION+" -> http://www.sonnyjs.org/")};b.Instance.prototype.isMobile=function(){navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)?this.MOBILE=!0:this.MOBILE=!1};b.Instance.prototype.resize=function(){var a=this;window.addEventListener("resize",
function(){a.WIDTH=window.innerWidth;a.HEIGHT=window.innerHeight})};b.Instance.prototype.toggleFullscreen=function(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?(document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),this.FULLSCREEN=!1):(document.documentElement.requestFullscreen?
document.documentElement.requestFullscreen():document.documentElement.msRequestFullscreen?document.documentElement.msRequestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),this.FULLSCREEN=!0);return this.FULLSCREEN};b.GET=function(){var a=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.3.0","Microsoft.XMLHTTP"];if(window.ActiveXObject)for(;0<
a.length;)try{return new window.ActiveXObject(a[0])}catch(b){throw Error(b);}else return window.XMLHttpRequest?new window.XMLHttpRequest:!1};if(window.SONNY)throw Error("SonnyJS was already declared in this scope!");this.SONNY=b}).call(this);