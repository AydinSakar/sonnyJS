/**
 * sonnyJS v0.1.0
 * www.github.com/felixmaier/sonnyJS
 * @author Felix Maier
 */
(function(){var b=b||{};b.VERSION="0.1.0";b.PAGEPATH="view/";b.FILETYPE=".html";b.HISTORY=window.history?!0:!1;b.ORIGINALHISTORY=window.location.href;b.INITIALIZED=0;b.SHOWVERSION=!1;b.Virtualiser=function(a){var e=this;b.LOADED||this.init(this.VIRTUALPAGES,function(c){e.PAGES=c;e.PAGES=e.interpreter.Includes(c);b.LOADED=!0;a();e.STARTPAGE?e.renderer.render(e.STARTPAGE):e.history&&e.history.additionalURL.length&&e.renderer.render(e.history.additionalURL+b.FILETYPE)})};b.Virtualiser.prototype.constructor=
b.Virtualiser;b.Virtualiser.prototype.init=function(a,e){var c=this,d={},f=0,k=function(a,h){Object.keys(a).forEach(function(g){a[g]instanceof Object||++f;a[g]instanceof Object?c.VIRTUALPAGES[g]&&(d[g]={},k(a[g],g)):d[h]&&c.GET(b.PAGEPATH+a[g],function(k){if(d[h][a[g]])throw Error("Multiple definition of "+d[h][a[g]].path+"!");var l=c.compiler;k=l.DOM(k);if("APP"!==k.tagName)throw Error('Missing "app" tag in '+a[g]+"!");l=l.HTML(k);l.content=l.inside;l.path=a[g];delete l.inside;d[h][a[g]]=new b.Page(l);
--f;0>=f&&e(d)})})};k(this.VIRTUALPAGES)};b.Virtualiser.prototype.GET=function(a,e){var c=new b.GET;c.onload=function(){if(200===this.status)e(this.responseText);else throw Error("Status code was "+this.status);};c.open("GET",a+"?"+(new Date).getTime(),!0);c.overrideMimeType&&c.overrideMimeType("text/html");c.send(null)};b.Page=function(a){this.name=String(a["sy-sitename"]);this.path=String(a.path);this.requireServer=Boolean(a["sy-requireserver"])||!1;this.content=a.content;this.includes=0;this.ready=
!0};b.Page.prototype.constructor=b.Page;b.Interpreter=function(a){a&&(this.__instance=a)};b.Interpreter.prototype.constructor=b.Interpreter;b.Interpreter.prototype.Includes=function(a){var e=this,c=a,d=function(a){for(var b in a)"object"===typeof a[b]&&(d(a[b]),a.content&&(c=a,a.content=f(a.content)));return a},f=function(a){for(var d in a)if("object"===typeof a[d]&&(a[d]=f(a[d]),a[d].key&&"syinclude"===a[d].key)){c.includes++;var h=f(e.__instance.renderer.get(a[d].page+b.FILETYPE)).content;a.splice(d,
!0);a.splice.apply(f(a),[d,0].concat(h))}return a};return d(c)};b.Compiler=function(a){a&&(this.__instance=a)};b.Compiler.prototype.constructor=b.Compiler;b.Compiler.prototype.DOM=function(a){var b=document.implementation.createHTMLDocument("html");b.documentElement.innerHTML=a;return b.body.children[0]};b.Compiler.prototype.HTML=function(a){if(!a instanceof Object)throw Error("Received arguments of invalid type");var b={};b.key=a.tagName.toLowerCase();if(a.hasAttribute)for(var c=0;c<a.attributes.length;c++)b[a.attributes[c].name]=
a.attributes[c].value;if(a.hasChildNodes()){a=a.firstChild;3===a.nodeType&&""!==a.data.trim()&&(b.text=a.data);if(3===a.nodeType&&a.nextSibling||1===a.nodeType)b.inside=[];for(;a;)1===a.nodeType&&b.inside.push(this.HTML(a)),a=a.nextSibling}return b};b.Compiler.prototype.JSON=function(a,e){var c,d=[];if("syinclude"!==a.key){for(var f in a)if("key"===f)c=document.createElement(a.key);else if("text"===f)c.innerHTML=a.text;else if("inside"===f){if(a.inside)for(var k=0;k<a.inside.length;++k){var m=this.JSON(a.inside[k]),
h;for(h in m)c.appendChild(m[h])}}else try{c&&"backup"!==f&&c.setAttribute(f,a[f])}catch(g){throw Error("JSON rendering failed: "+g);}c=(new b.Vivifier(this.__instance)).vivify(c);d.push(c)}return d};b.Vivifier=function(a){this.instance=a||this};b.Vivifier.prototype.constructor=b.Vivifier;b.Vivifier.prototype.vivify=function(a){var e=this;if(!a)throw Error("Invalid element type!");a.attributes["sy-load"]&&(a.attributes["sy-load"].value.match(":")?a=this.addListeners(a,"sy-load"):a.addEventListener("click",
function(){e.instance.render(a.attributes["sy-load"].value+b.FILETYPE)}));return a};b.Vivifier.prototype.addListeners=function(a,e){var c=this,d=a.attributes[e].value.split(":");if(2<=d[0].split("&").length)for(var d=d[0].match("&")?d[0].split("&"):d,f=0;f<d.length;f++)d[f].trim(),a.addEventListener(d[f],function(){c.instance.render(a.attributes[e].value.split(":")[1]+b.FILETYPE)});else a.addEventListener(d[0],function(){c.instance.render(d[1]+b.FILETYPE)});return a};b.Renderer=function(a){a&&(this.__instance=
a)};b.Renderer.prototype.constructor=b.Renderer;b.Renderer.prototype.render=function(a){a.match(".html")&&(a=a.split(".html")[0]);if(!a instanceof String)throw Error("Invalid page format!");this.page=this.get(a+b.FILETYPE);this.__instance.CURRENTPAGE=a;a=this.compile(this.page);for(var e in a)this.attach(a[e]);b.HISTORY&&this.__instance.history.update(this.__instance.CURRENTPAGE)};b.Renderer.prototype.kill=function(a){this.__instance.BODY&&(this.__instance.BODY.innerHTML="")};b.Renderer.prototype.compile=
function(a){var e=new b.Compiler(this),c=[];a=a.content||a;for(var d in a)c.push(e.JSON(a[d]));this.kill();return c};b.Renderer.prototype.attach=function(a){try{for(var b in a)this.__instance.BODY.appendChild(a[b])}catch(c){throw Error(c);}};b.Renderer.prototype.get=function(a){var e=this;a=a.match("/")?a.split("/"):a;var c,d,f,k=function(h,g){if(e.__instance.PAGES[h])k(e.__instance.PAGES[h],h);else{var m="";if(h&&g)for(var l in a)if(a[l].match(b.FILETYPE)){if(d=m+=a[l],f=c[d],!c[d])throw Error("The page "+
d+" does not exist or was not successfully loaded!");}else m+=a[l]+"/",e.__instance.PAGES[a[l]]&&(c=e.__instance.PAGES[a[l]])}},m;for(m in a)k(a[m]);return f};b.Notifications=function(a){a&&(this.__instance=a);"Notification"in window&&(this.notifySupport=!0,this.notification=null,this.permission=Notification.permission)};b.Notifications.prototype.constructor=b.Notifications;b.Notifications.prototype.show=function(a){this.notifySupport&&this.__instance.DISPLAYNOTIFICATIONS&&("granted"===this.permission?
"object"===typeof a&&(this.notification=new Notification(a.title,{tag:a.tag?a.tag:null,body:a.message?a.message:null,iconUrl:a.iconUrl?a.iconUrl:null,icon:a.icon?a.icon:null})):"denied"!==this.permission&&this.getPermission(a))};b.Notifications.prototype.getPermission=function(a){Notification.requestPermission(function(b){"granted"===b&&this.show(a)})};b.Connection=function(a){if(!window.io)throw Error("SonnyJS requires Socket.IO!");if(a)this.__instance=a;else throw Error("SONNY.Connection requires an instance!");
this.connected=!1;this.socket=io(window.location.host+":"+this.__instance.CONNECTIONPORT);this.connected=!0;this.__instance.ONLINE=!0;this.notifications=this.__instance.notify;this.init()};b.Connection.prototype.constructor=b.Connection;b.Connection.prototype.init=function(){var a=this;this.socket.on("connect",function(){a.notifications.show({title:"SONNY.Connection",message:"Connection established!",icon:"http://sonnyjs.org/favicon-96x96.png"})});this.socket.on("disconnect",function(){a.notifications.show({title:"SONNY.Connection",
message:"Connection closed!",icon:"http://sonnyjs.org/favicon-96x96.png"})})};b.HistoryManager=function(a){a&&(this.__instance=a);b.HISTORY&&(this.additionalURL=this.originalURL="",this.init())};b.HistoryManager.prototype.constructor=b.HistoryManager;b.HistoryManager.prototype.init=function(){var a=this.originalURL=b.ORIGINALHISTORY;RegExp("\\?","g").test(a)&&(a=a.split("?"),a[0]!==b.ORIGINALHISTORY&&(b.ORIGINALHISTORY=a[0],this.originalURL=b.ORIGINALHISTORY),a.length&&(this.additionalURL=a[1]))};
b.HistoryManager.prototype.update=function(a){window.history.replaceState("","",this.originalURL+"?"+a)};b.Instance=function(a,e){if(1<++b.INITIALIZED)throw Error("Cannot run multiple sonny instances!");var c=this;this.Greet();this.INSTANCE=this;this.STARTPAGE=null;this.PAGECONTAINER="syContainer";this.CURRENTPAGE=null;this.WIDTH=window.innerWidth;this.HEIGHT=window.innerHeight;this.CONNECTION=this.ONLINE=this.FULLSCREEN=!1;this.CONNECTIONPORT=9005;this.DISPLAYNOTIFICATIONS=!0;this.processSettings(a);
this.VIRTUALPAGES=a;this.isMobile();this.resize();this.BODY=document.querySelector(this.PAGECONTAINER)||null;this.renderer=new b.Renderer(this);this.interpreter=new b.Interpreter(this);this.compiler=new b.Compiler(this);this.notify=new b.Notifications(this);this.history=new b.HistoryManager(this);this.createContainer(function(){b.Virtualiser.call(c,function(){e();c.CONNECTION?c.CONNECTION=new b.Connection(c):null})})};b.Instance.prototype=Object.create(b.Virtualiser.prototype);b.Instance.prototype.constructor=
b.Instance;b.Instance.prototype.createContainer=function(a){var b=this;window.addEventListener("DOMContentLoaded",function(){if(!b.BODY&&!b.CONTAINER){var c=document.createElement(b.PAGECONTAINER);b.BODY=document.querySelector("body");b.BODY.appendChild(c);c=c.tagName.toLowerCase();c=document.querySelector(c);b.BODY=c}a()})};b.Instance.prototype.processSettings=function(a){if(a.Settings){if(!a.Settings instanceof Object)throw Error("Invalid settings type");for(var b in a.Settings){if(null===a.Settings[b]||
void 0===a.Settings[b])throw Error(b+" value is invalid");var c=b;b=String(b.toUpperCase());if(void 0!==this[b]||null===this[b])this[b]=a.Settings[c]}delete a.Settings}};b.Instance.prototype.Greet=function(){-1<navigator.userAgent.toLowerCase().indexOf("chrome")?console.log.apply(console,["%c sonny.js "+b.VERSION+" ->%c http://www.sonnyjs.org/ ","color: #d9d9d9; background: #000","background: #000"]):window.console&&console.log("sonny.js "+b.VERSION+" -> http://www.sonnyjs.org/")};b.Instance.prototype.isMobile=
function(){navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)?this.MOBILE=!0:this.MOBILE=!1};b.Instance.prototype.resize=function(){var a=this;window.addEventListener("resize",function(){a.WIDTH=window.innerWidth;a.HEIGHT=window.innerHeight;window.scrollTo(0,0)})};b.Instance.prototype.toggleFullscreen=
function(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?(document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),this.FULLSCREEN=!1):(document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.msRequestFullscreen?
document.documentElement.msRequestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),this.FULLSCREEN=!0);return this.FULLSCREEN};b.GET=function(){var a=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.3.0","Microsoft.XMLHTTP"];if(window.ActiveXObject)for(;0<a.length;)try{return new window.ActiveXObject(a[0])}catch(b){throw Error(b);
}else return window.XMLHttpRequest?new window.XMLHttpRequest:!1};if(window.SONNY)throw Error("SonnyJS was already declared in this scope!");this.SONNY=b}).call(this);